---
title: DDIA第三章-数据存储与检索笔记
date: 2021-11-29 22:49:52
tags: DDIA
---
# DDIA第三章-数据存储与检索 笔记

## 前言

开个DDIA的新坑。虽然DDIA笔记全网烂大街，但是自己敲出的好像更香一点，有侧重的记录也方便日后复习。从第三章开始，至少到第九章。三天一篇，不鸽！

## 几种索引

### 哈希索引

(key-value, 追加式日志)
内存中保存hash map，将每个键一一映射到数据文件中特定的字节偏移量。

将日志分解成段，当文件达到一定大小就关闭它，将后续写入到新的段文件。每个段有自己独立的hash map。查找时先找最新段的hash map，如果键不存在，检查第二新的段，以此类推。

可以在后台对这些段执行压缩。

值得注意的问题：

> + 删除记录：在文件中追加一个特殊的删除记录(tombstone)。合并日志段时，一旦发现墓碑标记，则会丢弃这个已删除键的所有值。
>
> + 崩溃恢复：崩溃后，内存中的hash map丢失。原则上可以通过从头读文件，重新构造hash map。优化方法是将每个段的hash map的快照存储在磁盘上。
>
> + 并发控制：由于写入以严格的先后顺序追加到日志中，所以一般写线程只能有一个。追加式日志非原地更新，所以可以被多个线程同时读取。

追加式日志的优点：

> + 追加和分段合并主要是顺序写，比随机写更好。
>
> + 追加式文件的并发和崩溃恢复更加简单。例如，不必担心在重写值时发生崩溃的情况，留下一个包含部分旧值和部分新值混杂在一起的文件。
>
> + 合并旧段可以避免磁盘空间碎片化的问题。

哈希索引的局限性：

> + 哈希表必须全部放入内存。原则上可以在磁盘上维护哈希表，但哈希表包含大量随机访问I/O。
>
> + 区域查询效率不高，只能采取逐个查找的方式查询每个键。

### SSTables和LSM-Tree

SSTable: Sorted String Table,排序字符串表。要求段文件中的kv对按键排序。

相较哈希索引的日志段的优点：

> + 合并段更加高效：merge sort。
>
> + 不需要在内存中保存所有键的索引：因为是有序的。因此内存索引可以是稀疏的。
>
> + 可以将多个记录压缩到一个块里，稀疏内存索引中的每个条目指向压缩块的开头。可以节省磁盘空间以及节约I/O带宽。

LSM-Tree: Log-Structured Merge-Tree，日志结构的合并树。

构建LSM-Tree的流程：

> + 当写入记录时，将其添加到内存的平衡树(又称内存表，memtable，e.g. 红黑树、AVL树)中。
>
> + 当内存表超限时，将其作为SSTable文件写入磁盘。在SSTable写磁盘时，写入可以继续添加一个新的内存表实例。
>
> + 为了处理读请求，先在内存表中查找键，然后是最新的SSTable,次新的SSTable，直到找到目标(或为空)。
>
> + 后台周期性地执行段合并与压缩。
>
> + 如果数据库崩溃，内存表丢失。可以在磁盘上保留一个单独的追加式日志，作为内存表数据的备份.

LSM-Tree的优化：

> + 查找数据库不存在的键时，需要把内存表和所有的SSTable全部查一遍。可以使用布隆过滤器（检索一个元素是否在集合中，如果过滤器说不在，那就一定不在，如果说在，也可能不在，重点是快）.
>
> + 压缩合并的策略：大小分级(Size-tired compaction)和分层压缩(leveled compaction)。具体可以看这里：[纯干货！深入探讨 LSM Compaction 机制](https://zhuanlan.zhihu.com/p/140325974)
>   + Size-tired: 较新的和较小的SSTables被连续合并到较旧和较大的SSTables。
>
>   + leveled: 键的范围分裂成多个更小的SSTables，旧数据被移动到单独的“层级”。

### B-Trees

略

### 对比B-Trees和LSM-Trees

LSM-Trees的优点:

> + LSM-Trees通常能够承受比B-Trees更高的写入吞吐量，一是它们有时可能有较低的写放大，二是它们以顺序方式写入SSTables，而不是重写树中的多个页。
>
> + LSM-Trees可以支持更好地压缩，因此通常磁盘上的文件比B-Trees小很多。

LSM-Trees的缺点: 

> + 日志结构存储的缺点：压缩时可能干扰正在进行的读写操作。磁盘的并发资源和写入带宽。
>
> + 日志结构的存储引擎可能在不同的段中具有相同键的多个副本。B-trees的每个键都唯一对应一个位置，对事务语义友好。

##列存

略（写了个寂寞）
