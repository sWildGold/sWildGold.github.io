---
title: DDIA第七章-事务笔记
date: 2021-11-29 22:46:54
tags: DDIA
---

# DDIA第七章-事务 笔记

## 前言

本文参考了

+ 《数据库系统概念-第七版》第17、18章
+ [事务前沿研究 | 隔离级别的追溯与究明，带你读懂 TiDB 的隔离级别（上篇）](https://pingcap.com/zh/blog/take-you-through-the-isolation-level-of-tidb-1)
+ [事务前沿研究丨事务并发控制](https://pingcap.com/zh/blog/transaction-frontiers-research-article-talk4)

## 事务的ACID

+ 原子性（Atomicity）：一个事务的所有效果在数据库中要么全部反映出来，要么根本不反映；故障不能让数据库处于事务部分执行的状态。但原子性不能保证事务的过程是原子发生的，还要配合Isolation。
+ 一致性（Consistency）：若数据库一开始是一致的，则事务执行后数据库仍处于一致性状态。这里的一致性是一种应用程序定义的状态正确性或不变性（invariants），例如，给账户打钱，两个账户最后的总金额应当不变。应用程序有责任正确地定义事务来保证一致性，这不是数据库可以保证的事情。(将C加入ACID只是为了让ACID听起来更顺口，当时并非觉得这是很重要的事情)
+ 隔离性（Isolation）：保证并发执行的事务是相互隔离的，互相感受不到对方的存在。ACID中的I指可串行化，即最后的结果与串行执行完全相同（等价）。
+ 持久性（Durability）：一旦事务提交，该事务的修改就不会丢失，即使出现系统故障。

下面的内容都是关于Isolation的。

## 竞态条件(race condition)

+ 脏读/Dirty Reads：读到了其他事务未提交的写。Read Committed及以上隔离级别可以防止脏读。
+ 脏写/Dirty Writes：写覆盖了其他事务未提交的写。所有隔离级别都防止脏读。
+ 读倾斜（不可重复读）/Read skew (Nonrepeatable Reads)：在不同的时间点看到不同的值。快照隔离是最常用的防范手段。
+ 更新丢失/Lost updates: 两个事务读-修改-写同一对象，导致其中一个覆盖另一个的写入。
+ 写倾斜/Write skew: 一般化的更新丢失。两个事务查询相同的对象，根据返回结果作出一些决定，然后更新其中的一些对象（不同的事务可能更新不同的对象），导致其中一个事务做决定的前提条件发生变化。只有serializable isolation可以防止。
+ 幻读/Phantom reads: DDIA 认为这是导致Write skew的根源.事务读取了某些符合查询条件的对象，同时另一事务执行写入，改变了先前的查询结果。

以上的概念貌似因为历史原因，盘根错节，特别复杂和混乱，这里的解释肯定也错误很多。看个大概就得了。

## 两阶段加锁(two-phase locking, 2PL)

+ 如果事务A已经读取了某个对象，此时事务B想要写入改对象，等A提交或终止。
+ 如果事务A已经修改了某个对象，此时事务B想要读取该对象，等A提交或终止。

### 2PL的实现

+ 如果事务要读取对象，必须获取共享锁。可以有多个事务同时获得共享锁，但如果独占锁已给出，则其他事务必须等待。
+ 如果事务要修改对象，必须获取独占锁。获取独占锁之前不能有锁。也就是说，如果对象已被上锁，则修改事务必须等待。
+ 如果事务先读取对象，再修改对象，需要将共享锁升级为独占锁。升级锁的流程等价于直接获得独占锁。
+ 事务获得锁之后，一直持有锁直到事务结束。这也是名字'two-phase'的来源，在第一阶段（事务执行之前）获取锁，在第二阶段（事务结束时）释放锁。

### 谓词锁

serializable isolation需要防止幻读问题。因此2PL需要引入谓词锁。它的作用类似于之前描述的共享/独占锁，而区别在于，它并不属于某个特定的对象（如表的某一行），而是作用于满足某些搜索条件的所有查询对象。

谓词锁会限制如下访问：

+ 如果事务A想要读取某些满足匹配条件的对象，例如采用SELECT查询，它必须以共享模式获得查询条件的谓词锁。如果另一个事务B正持有任何一个匹配对象的互斥锁，那么A必须等到B释放锁之后才能继续执行查询。
+ 如果事务A想要插入、更新或删除任何对象，则必须首先检查所有旧值和新值是否与现有的任何谓词锁匹配（即冲突）。如果事务B持有这样的谓词锁，那么A必须等到B完成后才能继续。

### 索引区间锁

谓词锁性能不佳。索引区间锁是将谓词锁保护的对象扩大化，选一个合适的索引对其施加共享锁。虽然索引区间锁会锁住更大的范围，但是开销更低。

